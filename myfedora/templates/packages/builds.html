<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude">
<xi:include href="../master.html"/>
<head>
<title>Package $package</title>
<script src="${tg.url('/static/js/jquery.js')}" type="text/javascript"></script>
<script src="${tg.url('/static/js/jquery.dimentions.js')}" type="text/javascript"></script>
</head>
<body>
    <h2>Package $package</h2>
    <!-- FIXME: These scripts should be in the head but something is not working
                with template merging so they are here for now -->
    <script src="${tg.url('/static/js/myfedora.ui.js')}" type="text/javascript"></script>
    <script src="${tg.url('/static/js/myfedora.util.js')}" type="text/javascript"></script>
    <script type="text/javascript">
      function render_updates(block, data, user_data)
      {
        var message_block = $("#" + user_data.message_block_id);
        msg_div = $("<div/>");

        var update = data.updates[0]
        if (update) {
          var msg_div = $("<div/>");
          var legacy_test = true;

          var rstatus = update.status
          if (rstatus) {
            msg_div.append("<b>release status: </b>" + rstatus + "<br/>");
            legacy_test = false;
          }

          var push_requested = update.request;
          if (push_requested) {
            msg_div.append("<b>push request: </b>" + rstatus + "<br/>");
            legacy_test = false;
          }

          var release_note = update.note;
          if (release_note) {
            msg_div.append("<b>release notes: </b>" + release_note + "<br/>");
            legacy_test = false;
          }

          if (legacy_test) 
            msg_div.append(update);

          message_block.html(msg_div); 
          message_block.parent().fadeIn("slow");
        }
      }

      function render_release_tags(block, data, user_data)
      {
        var updates_match = /.*-(updates|testing|candidate)/;
        var updates_block_id = "updates_info_" + block[0].id;
        var query_updates = false;
        var tags = data.tags;        

        var text = $("<div />");
        block.html(text);
        block.append($("<div />").attr("id", updates_block_id));

        for (var i in tags) {
           var name = tags[i]['name'];
           text.append(name);
           
           if (name.match(updates_match)) 
             query_updates = true;  
        }
        
        if (query_updates){ 
          mf_replace_block_async(updates_block_id, 
                                 "${tg.url('/mfquery/bodhi/get_info')}",
                                 {'package': user_data.package},
                                 render_updates,
                                 user_data);
        }
      }

      function _render_files_tags_more_or_less(hidden_class_name)
      {
        var more_link = $("#" + hidden_class_name);
        var hidden_dl = $("." + hidden_class_name);
 
        var link_text = more_link.text()
        if (link_text == "more") {
          more_link.text("less");
          hidden_dl.slideDown();
        } else {
          more_link.text("more");
          hidden_dl.slideUp();
        }
      } 
 
      function render_files_tags(block, data, user_data)
      {
        var hidden_class_name = "more_" + block[0].id;
        var dl_item = $("<li/>").text("Dowloads")
        
        /* show and hide hidden files */
        var more_or_less = $("<span/>").text("[");
        var more_link = $("<a/>").attr("id", hidden_class_name);
        more_link.attr("href","javascript:void(0);");
        more_link.attr("onClick", "_render_files_tags_more_or_less('" + hidden_class_name + "')");
        more_link.text("more");
        more_or_less.append(more_link);
        more_or_less.append("]");
        dl_item.append(more_or_less).append($("<br />"));

        /* guess the user's arch and only display those files
           unless expanded with the more link */
        var arch = mf_guess_client_arch('i386'); 

        var downloads = data.files.downloads;
        var devel_file_match = /.*-(devel|doc|debuginfo)-.*/;

        /* loop over primary arch */
        for (i in arch) {
          var a = arch[i];
          arch_files = downloads[a];


          if (arch_files) {
            dl_item.append(a);
            var arch_list = $("<ul />");
 
            for (i in arch_files) {
              var f = arch_files[i];

              arch_item = $("<li/>");
              if (f.name.match(devel_file_match))
                arch_item.attr("class", hidden_class_name);

              dl_link = $("<a/>").attr("href", f.url).append(f.name);
              arch_item.append(dl_link);
              arch_list.append(arch_item);
            }

            dl_item.append(arch_list);
            delete downloads[a];

            /* only get the first arch with files 
             * since it should be the best match
             */
            break;
          }
        }

        /* FIXME: The above loop and this one are essentally the same
                  break it out into another function */
        /* loop over the rest of the arches and add them hidden */
        for (a in downloads) {
          arch_files = downloads[a];
          if (arch_files) {
            var arch_list = $("<ul />");

            arch_div = $("<div/>").attr("class", hidden_class_name).append(a);
 
            for (i in arch_files) {
              var f = arch_files[i];

              arch_item = $("<li/>");

              dl_link = $("<a/>").attr("href", f.url).append(f.name);
              arch_item.append(dl_link);
              arch_list.append(arch_item);
            }

            arch_div.append(arch_list);
            dl_item.append(arch_div);
          }
        }

        dl_item.find("." + hidden_class_name).hide();

        dl_item.hide();
        block.html(dl_item);
        dl_item.slideDown(); 
      }

      function render_log_message(block, data, user_data)
      {
        var css_class = user_data["css_class"];
        block.addClass(css_class);

        log_url = data.log_url;
        log_name = data.log_name;

        msg_div = $("<div/>");
        msg_div.append("Error in build.");
        if (log_url) {
          link = $("<a/>").attr("href", log_url).attr("target", "_blank");
          link.append("You can refer to log ");
          link.append(log_name);
          link.append(" for more details");
          msg_div.append(link);
        } else {
          msg_div.append(" No logs are available to inspect");
        }

        block.html(msg_div);
        block.parent().fadeIn();
      }

    </script>
<div id="tabfloat">
<ul id="primary-links">
<span py:for="r in resource_urls"><li><a href="${tg.url(package_url + '/' + r">${r}</a></li> </span>
</ul>
</div>
  <div id="resource_content">
     <!-- TODO: CSS -->
     <form name="builds_navigation_form" action="${current_url}">
       <a onClick="document.builds_navigation_form.direction.value='prev'; document.builds_navigation_form.submit()" href="#" py:if="previous_disabled != 'disabled'">&lt;-- prev </a>
       <a onClick="document.builds_navigation_form.direction.value='next'; document.builds_navigation_form.submit()" href="#" py:if="next_disabled != 'disabled'">next --&gt; </a>
       <input type="hidden" name="offset" value="${offset}" />
       <input type="hidden" name="limit" value="${limit}" />
       <input type="hidden" name="direction" value="next"/>
     </form> 
     <table>
        <tr class="table_header1">
          <td class="table_header_col1">Build ID</td>
          <td class="table_header_col1">Name</td>
          <td class="table_header_col1">Build By</td>
          <td class="table_header_col1">Started</td>
          <td class="table_header_col1">Finished</td>
          <td class="table_header_col1">State</td>
          <td class="table_header_col1">Release</td>
        </tr>
        <span py:for="build in builds_list" 
              py:with="build_id=str(build['build_id']); build_state=str(build['state']); task_id=str(build['task_id']); message_id='message_' + build_id">
        <tr>  
          <td>${build_id}</td>
          <!-- for now send to koji but we want a simpler page
               with the most common info organized nicely -->
          <td py:with="menu_id='menu_' + build_id" >
            <div onMouseOver="mf_menu_hover_start('${menu_id}'); load_files_${menu_id}();" 
                 onMouseOut="mf_menu_hover_stop()">
              <a href="https://koji.fedoraproject.org/koji/buildinfo?buildID=${build_id}" target="_blank">${str(build['nvr'])}</a>
              <div class="menu" id="${menu_id}" rowspan="4">
                <ul>
                  <li><a href="https://koji.fedoraproject.org/koji/buildinfo?buildID=${build_id}" target="_blank" >Details</a></li>
                  <span py:with="files_id = 'files_' + menu_id" id="${files_id}">
                     <script type="text/javascript">
                       files_loading_${menu_id} = false;
                       function load_files_${menu_id}() {
                           if (files_loading_${menu_id})
                             return;

                           files_loading_${menu_id} = true;
                      
                           mf_replace_block_async('${files_id}', 
                                                  "${tg.url('/mfquery/koji/get_files')}",
                                                  {'task_id':'${task_id}'},
                                                  render_files_tags,
                                                  '');
                       };
                     </script>

                    <li py:if="build_state == '1'" py:with="dl_base_url='http://koji.fedoraproject.org/packages/' + package + '/' + build['version'] + '/' + build['release']">
                      Downloads<br/>
                          <img src="/static/images/spinner-20.gif" />
                    </li>
                  </span>
                </ul>
              </div>
            </div> 
          </td>
          <td>${str(build['owner_name'])}</td>
          <td>${str(build['creation_time'])}</td>
          <td>${str(build['completion_time'])}</td>
          <td><img src="${tg.url(str(build['mf_state_img']))}" /></td>
          <td 
              py:with="release_id='release_' + build_id"
              id="${release_id}">
            <span py:if="build_state=='1'">
              <script type="text/javascript">
                $(document).ready(
                function () {
                  mf_replace_block_async('${release_id}', 
                                         "${tg.url('/mfquery/koji/get_tags')}",
                                          {'build_id':'${build_id}'},
                                          render_release_tags,
                                          {"package":"${str(build['nvr'])}",
                                           "message_block_id": "${message_id}"
                                          });
                });
              </script>
              <img src="${tg.url('/static/images/spinner-20.gif')}" />
            </span>
          </td>
        </tr>
        <tr class="message_row">
          <td></td>
          <td colspan="6" 
              id="${message_id}">
            <span py:if="build_state=='3'">
              <script type="text/javascript">
                $(document).ready(
                function () {
                  mf_replace_block_async('${message_id}', 
                                         "${tg.url('/mfquery/koji/get_error_log')}",
                                          {'task_id':'${task_id}'},
                                          render_log_message,
                                          {'css_class':'error_message'});
                });
              </script>
            </span>
          </td>
        </tr>
        </span> 

     </table> 
  </div>
</body>
</html>
