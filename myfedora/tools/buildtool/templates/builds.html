<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude">
<xi:include href="${myfedora.resource.get_master_template()}"/>
<head>
<title>Builds</title>
  <script src="${tg.url('/static/js/jquery.js')}" type="text/javascript"></script>
  <script src="${tg.url('/static/js/myfedora.ui.js')}" type="text/javascript"></script>
  <script src="${tg.url('/static/js/myfedora.util.js')}" type="text/javascript"></script>

  <script type="text/javascript">
      function render_updates(block, data, user_data)
      {
        var message_block = $("#" + user_data.message_block_id);
        msg_div = $("<div/>");

        var update = data.updates[0];
        if (update) {
          var msg_div = $("<div/>");
          var msg_list = $("<ul/>");
          msg_div.append(msg_list);
          var legacy_test = true;

          var ustatus = update.status;
          if (ustatus) {
            var list_item = $("<li />");
            list_item.append("<b>release status: </b>" + ustatus);
            msg_list.append(list_item);
            legacy_test = false;
          }

          var urequest = update.request;
          if (urequest) {
            var list_item = $("<li />");
            list_item.append("<b>push request: </b>" + urequest);
            msg_list.append(list_item);
            legacy_test = false;
          }

          var release_note = update.note;
          if (release_note) {
            var list_item = $("<li />");
            list_item.append("<b>release notes: </b>" + release_note);
            msg_list.append(list_item);
            legacy_test = false;
          }

          if (legacy_test) 
            msg_list.append($("<li/>")).append(update);

          if (update.can_modify) {
             var form_has_data = false;
             var update_form = $("<form />").attr("name","modify_build_update");
             update_form.attr("action","javascript:void(0);");

             if (urequest) {
               var button;
               if (urequest == "testing") {
                 button = $('<input type="submit" />').attr('value','Request move to stable');
                 update_form.append(button);
                 update_form.append(" ");
                 form_has_data = true;
               }
 
               if (ustatus == "pending") {
                 button = $('<input type="submit" />').attr('value','Cancel request');
                 update_form.append(button);
                 form_has_data = true;
               }
             }

             if (form_has_data)
               msg_list.append(update_form);
          }

          message_block.html(msg_div); 
          message_block.parent().fadeIn("slow");
        }
      }

      function render_release_tags(block, data, user_data)
      {
        var updates_match = /.*-(updates|testing|candidate)/;
        var updates_block_id = "updates_info_" + block[0].id;
        var query_updates = false;
        var tags = data.tags;        

        var tag_div = $("<div />");
        var tag_list = $("<ul />");
        tag_div.append(tag_list);
        block.html(tag_div);
        block.append($("<div />").attr("id", updates_block_id));

        for (var i in tags) {
           var name = tags[i]['name'];
           var list_item = $("<li />").append(name);
           tag_list.append(list_item);
           
           if (name.match(updates_match)) 
             query_updates = true;  
        }
        
        if (query_updates){ 
          mf_replace_block_async(updates_block_id, 
                                 "${tg.url('/mfquery/bodhi/get_info')}",
                                 {'package': user_data.package,
                                  'get_auth': true},
                                 render_updates,
                                 user_data);
        }
      }

      function _render_files_tags_more_or_less(downloads)
      {
        var arch_item; 
        var arch_list = $("<ul />");

        /* loop over the downloads and add them to the display */
        for (a in downloads) {
          arch_files = downloads[a];
          if (arch_files) {
            var arch_li = $("<li />").append(a);
            var arch_ul = $("<ul />");
            for (i in arch_files) {
              var f = arch_files[i];

              arch_item = $("<li/>");

              var dl_link = $("<a/>").attr("href", f.url).append(f.name);
              arch_item.append(dl_link);
              arch_ul.append(arch_item);
            }

            arch_li.append(arch_ul);
            arch_list.append(arch_li);
          }
        }

        var download_div = $("<div />").css(
                        {
                          "background-color": "#ffffff"
                        });

        download_div.append(arch_list);
       
        close_button_div = $("<div />").attr("class", "link_button"); 
        close_button = $("<a />").attr("href", "javascript:void(0)");
        close_button.click(function (){mf_hide_overlay('mf_overlay');});
        close_button.append("X Close");
        close_button_div.append(close_button);
        download_div.append(arch_list);
        download_div.append(close_button_div);

        var overlay = mf_show_overlay("mf_overlay", download_div, 5);
      } 
 
      function render_files_tags(block, data, user_data)
     {
        var hidden_class_name = "more_" + block[0].id;
        var dl_item = $("<li/>").text("Dowloads");
        var downloads = data.files.downloads;       
 
        /* show and hide all files */
        var more_or_less = $("<span/>").text("[");
        var more_link = $("<a/>").attr("id", hidden_class_name);
        more_link.attr("href","javascript:void(0);");

        more_link.click(function() {
                          _render_files_tags_more_or_less(downloads); 
                        });

        more_link.text("more");
        more_or_less.append(more_link);
        more_or_less.append("]");
        dl_item.append(more_or_less).append($("<br />"));

        /* guess the user's arch and only display those files
           unless expanded with the more link */
        var arch = mf_guess_client_arch('i386'); 

        var devel_file_match = /.*-(devel|doc|debuginfo)-.*/;

        /* loop over primary arch */
        for (i in arch) {
          var a = arch[i];
          arch_files = downloads[a];


          if (arch_files) {
            dl_item.append(a);
            var arch_list = $("<ul />");
 
            for (i in arch_files) {
              var f = arch_files[i];

              // don't diplay devel files
              if (f.name.match(devel_file_match))
                continue;

              arch_item = $("<li/>");

              dl_link = $("<a/>").attr("href", f.url).append(f.name);
              arch_item.append(dl_link);
              arch_list.append(arch_item);
            }

            dl_item.append(arch_list);
            delete downloads[a];

            /* only get the first arch with files 
             * since it should be the best match
             */
            break;
          }
        }

        dl_item.hide();
        block.html(dl_item);
        dl_item.slideDown(); 
      }

      function render_log_message(block, data, user_data)
      {
        var css_class = user_data["css_class"];
        block.addClass(css_class);

        log_url = data.log_url;
        log_name = data.log_name;

        name_col = $('#' + user_data.build_id + '_name_col');
        name_col.addClass(css_class);

        msg_div = $("<div/>").addClass('details');
        msg_div.append("Error in build.");
        if (log_url) {
          link = $("<a/>").attr("href", log_url).attr("target", "_blank");
          link.append("You can refer to log ");
          link.append(log_name);
          link.append(" for more details");
          msg_div.append(link);
        } else {
          msg_div.append(" No logs are available to inspect");
        }

        block.html(msg_div);
        block.parent().fadeIn();
      }

  </script>
</head>
<body>
  <div id="mf_overlay" style="opacity:0; zindex:-1"/>
  <div id="resource_content">
     <!-- TODO: CSS -->
     <form name="builds_navigation_form" action="${myfedora.current_url}">
       <a onClick="document.builds_navigation_form.direction.value='prev'; document.builds_navigation_form.submit()" href="#" py:if="previous_disabled != 'disabled'">&lt;-- prev </a>
       <a onClick="document.builds_navigation_form.direction.value='next'; document.builds_navigation_form.submit()" href="#" py:if="next_disabled != 'disabled'">next --&gt; </a>
       <input type="hidden" name="offset" value="${offset}" />
       <input type="hidden" name="limit" value="${limit}" />
       <input type="hidden" name="direction" value="next"/>
     </form> 
     <table class="content_table">
        <thead>
          <tr>
            <th>Build ID</th>
            <th>Name</th>
            <th>Build By</th>
            <th>Started</th>
            <th>Finished</th>
            <th>State</th>
            <th>Release</th>
          </tr>
        </thead>
        <tbody py:with="oe = tg.cycle(('odd','even'));">
        <span py:for="build in builds_list" 
              py:with="build_id=str(build['build_id']); 
                       build_state=str(build['state']); 
                       task_id=str(build['task_id']); 
                       message_id='message_' + build_id;">
         <?python odd_or_even = oe.next() ?>
         <tr class="${odd_or_even}">
          <td>${build_id}</td>
          <!-- for now send to koji but we want a simpler page
               with the most common info organized nicely -->
          <td py:with="menu_id='menu_' + build_id" id="${build_id}_name_col">
            <div onMouseOver="mf_menu_hover_start('${menu_id}'); load_files_${menu_id}();" 
                 onMouseOut="mf_menu_hover_stop()">
              <a href="https://koji.fedoraproject.org/koji/buildinfo?buildID=${build_id}" target="_blank">${str(build['nvr'])}</a>
              <div class="menu" id="${menu_id}" rowspan="4">
                <ul>
                  <li><a href="https://koji.fedoraproject.org/koji/buildinfo?buildID=${build_id}" target="_blank" >Details</a></li>
                  <span py:with="files_id = 'files_' + menu_id" id="${files_id}">
                     <script type="text/javascript">
                       files_loading_${menu_id} = false;
                       function load_files_${menu_id}() {
                           if (files_loading_${menu_id})
                             return;

                           files_loading_${menu_id} = true;
                      
                           mf_replace_block_async('${files_id}', 
                                                  "${tg.url('/mfquery/koji/get_files')}",
                                                  {'task_id':'${task_id}'},
                                                  render_files_tags,
                                                  '');
                       };
                     </script>

                    <li py:if="build_state == '1'" >
                      Downloads<br/>
                          <img src="/static/images/spinner-20.gif" />
                    </li>
                  </span>
                </ul>
              </div>
            </div> 
          </td>
          <td>${str(build['owner_name'])}</td>
          <td>${str(build['creation_time'])}</td>
          <td>${str(build['completion_time'])}</td>
          <td><img src="${tg.url(str(build['mf_state_img']))}" /></td>
          <td 
              py:with="release_id='release_' + build_id"
              id="${release_id}">
            <span py:if="build_state=='1'">
              <script type="text/javascript">
                $(document).ready(
                function () {
                  mf_replace_block_async('${release_id}', 
                                         "${tg.url('/mfquery/koji/get_tags')}",
                                          {'build_id':'${build_id}'},
                                          render_release_tags,
                                          {"package":"${str(build['nvr'])}",
                                           "message_block_id": "${message_id}"
                                          });
                });
              </script>
              <img src="${tg.url('/static/images/spinner-20.gif')}" />
            </span>
          </td>
        </tr>
        <tr class="message_row, ${odd_or_even}">
          <td> </td>
          <td colspan="6" 
              id="${message_id}">
            <span py:if="build_state=='3'">
              <script type="text/javascript">
                $(document).ready(
                function () {
                  mf_replace_block_async('${message_id}', 
                                         "${tg.url('/mfquery/koji/get_error_log')}",
                                          {'task_id':'${task_id}'},
                                          render_log_message,
                                          {'css_class':'error_message', 'build_id':'${build_id}'});
                });
              </script>
            </span>
          </td>
        </tr>
       </span>
      </tbody> 
     </table> 
  </div>
</body>
</html>
